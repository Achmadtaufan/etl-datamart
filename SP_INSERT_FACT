CREATE OR ALTER PROCEDURE SP_INSERT_FACT_ISSUANCE_ADD
AS        

BEGIN        
	/* CREATE BY ACHMAD TAUFAN, BRS: Upload Portfolio Daily Sales Dashboard Manual, 20250922 */    

IF OBJECT_ID('TEMPDB..#TEMP_CL_ADD_POL_SUMMARY') IS NOT NULL
BEGIN
DROP TABLE #TEMP_CL_ADD_POL_SUMMARY
END

SELECT CAST(CONVERT(CHAR(8),ISSUED_DATE,112) AS INT) AS TRX_DATE, 'REAL' AS VALUE_TYPE, SUM(APE) APE, COUNT(DISTINCT POLICY_NUMBER) CASES, CHANNEL_CODE, PRODUCT_CODE AS PRODUCT_ID,
CASE WHEN BILLING_FREQ='00' THEN 'Single' ELSE 'Regular' END AS TRX_TYPE, PARTNERSHIP AS PARTNERSHIP_ID
INTO #TEMP_CL_ADD_POL_SUMMARY
FROM STG.DBO.CL_ADD_POLICY WITH(NOLOCK)
GROUP BY CHANNEL_CODE,PARTNERSHIP,ISSUED_DATE,PRODUCT_CODE,
CASE WHEN BILLING_FREQ='00' THEN 'Single' ELSE 'Regular' END


MERGE DWH_FWDII.DBO.FACT_ISSUANCE_ADD AS TARGET
USING #TEMP_CL_ADD_POL_SUMMARY AS SOURCE
ON TARGET.TRX_DATE=SOURCE.TRX_DATE AND TARGET.PRODUCT_ID=SOURCE.PRODUCT_ID
WHEN MATCHED THEN
UPDATE
SET  TARGET.VALUE_TYPE=SOURCE.VALUE_TYPE
	,TARGET.APE=SOURCE.APE
	,TARGET.CASES=SOURCE.CASES
	,TARGET.CHANNEL_CODE=SOURCE.CHANNEL_CODE
	,TARGET.TRX_TYPE=SOURCE.TRX_TYPE
	,TARGET.PARTNERSHIP_ID=SOURCE.PARTNERSHIP_ID
WHEN NOT MATCHED THEN
INSERT (TRX_DATE,VALUE_TYPE,APE,CASES,CHANNEL_CODE,PRODUCT_ID,TRX_TYPE,PARTNERSHIP_ID)
VALUES(SOURCE.TRX_DATE,SOURCE.VALUE_TYPE,SOURCE.APE,SOURCE.CASES,SOURCE.CHANNEL_CODE,SOURCE.PRODUCT_ID,SOURCE.TRX_TYPE,SOURCE.PARTNERSHIP_ID);

END


