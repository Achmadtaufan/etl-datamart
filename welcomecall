-- 1) Optimized: use OUTER APPLY / ROW_NUMBER to get latest rows per agent/policy
WITH POL_COMBINED AS (
    SELECT POLICYNUM, IsRemoteSelling
    FROM STG.DBO.NB_POLICY
    UNION ALL
    SELECT POLICY_ID AS POLICYNUM, CONVERT(NVARCHAR(220), remote_selling) AS IsRemoteSelling
    FROM STG.DBO.OWB_NB_POLICY
),
KPI_LATEST AS (
    SELECT AGENTID, DEFINITIONTYPECD, KPI_VALUE, PERIODE
    FROM (
        SELECT A.AGENTID, A.DEFINITIONTYPECD, A.KPI_VALUE, A.PERIODE,
               ROW_NUMBER() OVER (PARTITION BY A.AGENTID ORDER BY A.PERIODE DESC) AS rn
        FROM AGENT_KPI_SUMMARY A
        WHERE A.DEFINITIONTYPECD = 'PERSISTENCY_S24' -- push predicate in
    ) t
    WHERE rn = 1
),
HOLD_LATEST AS (
    SELECT AGENTID AS AGENT_IDS, HOLDSTATUS, STATUSDATE, CATEGORYHOLD
    FROM (
        SELECT Z.AGENTID, Z.HOLDSTATUS, Z.STATUSDATE, Z.CATEGORYHOLD,
               ROW_NUMBER() OVER (PARTITION BY Z.AGENTID ORDER BY Z.STATUSDATE DESC) AS rn
        FROM [DMSPROD].[C2L_DMS].[dbo].[AGENT_HOLD_STATUS] Z
        WHERE Z.CATEGORYHOLD = 'REPORTHOLD' -- push predicate early
    ) t
    WHERE rn = 1
)
SELECT
    CW.[POLICY_NUMBER],
    [ISSUED_DATE] = CONVERT(VARCHAR(10), CONVERT(DATE, CW.ISSUED_DATE), 120),
    [DOB_PEMEGANG_POLIS] = CONVERT(VARCHAR(10), CONVERT(DATE, PP_DOB), 120),
    [DOB_TERTANGGUNG_POLIS] = CONVERT(VARCHAR(10), CONVERT(DATE, TTG_DOB), 120),
    -- NOTE: scalar UDF called many times below (see notes)
    [NAMA_PEMEGANG_POLIS] = dbo.RemoveNonAlphaNumericCharacters2(LTRIM(RTRIM([PP_NAME]))),
    [NAMA_TERTANGGUNG]   = dbo.RemoveNonAlphaNumericCharacters2(LTRIM(RTRIM([TTG_NAME]))),
    [ALAMAT_PEMEGANG_POLIS] = dbo.RemoveNonAlphaNumericCharacters2(LTRIM(RTRIM(REPLACE([PP_ADDRESS],'  ',' ')))),
    [HANDPHONE_PEMEGANG_POLIS] = dbo.RemoveNonAlphaNumericCharacters2(LTRIM(RTRIM([PP_HANDPHONE]))),
    [RIDER],
    cw.[POLICY_STATUS],
    cw.[CURRENCY],
    cw.[PLAN_CODE],
    dbo.RemoveNonAlphaNumericCharacters2(cw.[PLAN_NAME]) AS [PLAN_NAME],
    cw.[BILLING_FREQ],
    cw.[SUM_INSURED],
    cw.[BASIC_PREMIUM],
    cw.[SINGLE_PREMIUM],
    cw.[DELIVERY_MODE],
    [AGENT_CODE],
    dbo.RemoveNonAlphaNumericCharacters2(LTRIM(RTRIM(REPLACE(CW.[AGENT_NAME],'  ',' ')))) AS [AGENT_NAME],
    dbo.RemoveNonAlphaNumericCharacters2(LTRIM(RTRIM([AGENT_HANDPHONE]))) AS AGENT_HANDPHONE,
    dbo.RemoveNonAlphaNumericCharacters2(LTRIM(RTRIM(REPLACE([BANKSTAFF_NAME],'   ',' ')))) AS [BANKSTAFF_NAME],
    dbo.RemoveNonAlphaNumericCharacters2(LTRIM(RTRIM(REPLACE([BANKBRANCH],'  ',' ')))) AS BANKBRANCH,
    dbo.RemoveNonAlphaNumericCharacters2(RTRIM(EMAIL_ID)) AS EMAIL_ID,
    DATEDIFF(DAY,CW.[PP_DOB],CW.[ISSUED_DATE]) / 365 AS [AGE],
    DATEDIFF(DAY,CW.[TTG_DOB],CW.[ISSUED_DATE]) / 365 AS [AGE_TTG],
    dbo.RemoveNonAlphaNumericCharacters2(STP.REMARKS) AS REMARKS,
    [TOP_UP] = TOP_UP,
    CIF = dbo.RemoveNonAlphaNumericCharacters2(RTRIM(CW.CIF_NO)),
    CASE WHEN cw.PARTNERSHIP = 'Bank Commonwealth' THEN 'PTBC' ELSE cw.PARTNERSHIP END [PARTNERSHIP],
    ISNULL(POL.IsRemoteSelling, 'NO') AS [IsRemoteSelling],
    dbo.RemoveNonAlphaNumericCharacters2(LTRIM(RTRIM(REPLACE(AG.AGENT_NAME,'  ',' ')))) AS LEADER,
    CONVERT(VARCHAR(10), CONVERT(DATE, DM.JOIN_DATE), 120) AS JOIN_DATE,
    dbo.RemoveNonAlphaNumericCharacters2(LTRIM(RTRIM(DM.AGENT_LEVEL))) AS AGENT_LEVEL,
    dbo.RemoveNonAlphaNumericCharacters2(LTRIM(RTRIM(DM.JUMBO))) AS JUMBO,
    dbo.RemoveNonAlphaNumericCharacters2(LTRIM(RTRIM(DM.SD))) AS SD,
    Persistensi = ISNULL(CAST(KPI.KPI_VALUE AS VARCHAR(50)), '0.00'),
    FlaggedAgent = CASE 
                      WHEN HS.HOLDSTATUS = 'HOLD' AND HS.CATEGORYHOLD = 'REPORTHOLD' THEN 'Y'
                      WHEN HS.HOLDSTATUS = 'RELEASE' AND HS.CATEGORYHOLD = 'REPORTHOLD' THEN 'N'
                      ELSE 'N'
                   END
FROM dbreport.dbo.[v_CRM_WELCOME_CALL] cw WITH (NOLOCK)
LEFT JOIN (
    -- keep only latest remark per policy via MAX(ID)
    SELECT NM.POLICYNUM AS POLICY_NUMBER, NM.REMARKS
    FROM stg.dbo.[NB_LISTSTP] NM WITH (NOLOCK)
    INNER JOIN (
        SELECT POLICYNUM, MAX(ID) AS ID
        FROM stg.dbo.[NB_LISTSTP] WITH (NOLOCK)
        GROUP BY POLICYNUM
    ) MX ON MX.ID = NM.ID AND MX.POLICYNUM = NM.POLICYNUM
) STP ON STP.POLICY_NUMBER = CW.POLICY_NUMBER
LEFT JOIN POL_COMBINED POL ON POL.POLICYNUM = CW.POLICY_NUMBER
LEFT JOIN V_DIM_AGENT DM ON CW.[AGENT_CODE] = DM.AGENT_ID
LEFT JOIN DM_AGENTHIERARCHY AH ON AH.AGENT_ID = DM.AGENT_ID AND AH.END_DATE IS NULL
LEFT JOIN DM_AGENTS AG ON AG.AGENT_ID = AH.PARENT_AGENT_ID
LEFT JOIN KPI_LATEST KPI ON CW.[AGENT_CODE] = KPI.AGENTID
LEFT JOIN HOLD_LATEST HS ON CW.[AGENT_CODE] = HS.AGENT_IDS;